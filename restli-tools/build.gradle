plugins {
  id "java-library"
}

// This block is only supported and required when building with JDK11+
if (JavaVersion.current() >= JavaVersion.VERSION_11) {
  // We need a custom source set for JDK11+ classes
  // Note that we use java 17 as the source set entry point to minimize the impact on existing Java 8 and Java 11 consumers.
  // This is because the JVM of the consumer will pick up the highest bytecode version which is lower than or equal to the JVM version.
  // So, for Java 8 and Java 11 consumers, Java 17 does not qualify since it is higher than 8 and 11, which means they will
  // fall back to using the default Java 8 level bytecode.
  sourceSets {
    java17 {
      java {
        srcDirs = ['src/main/java17']
      }
    }
  }
  // This compile task is automatically generated by java-library plugin for custom JDK11 only source set
  // We need to explicitly set code versions and override defaults
  compileJava17Java {
    sourceCompatibility = 11
    targetCompatibility = 11
    options.compilerArgs.addAll(['--release', '11'])
  }

  jar {
    // We package JDK11+ classes into a custom folder.
    // JVM will load the class if version of the class is equal or less than version of JVM.
    // Thus JDK8 or JDK9 will load default class from "com" folder and JDK11+ will load the custom folder
    into('META-INF/versions/17') {
      from sourceSets.java17.output
    }
    manifest {
      attributes(
          "Manifest-Version": "1.0",
          "Multi-Release": true
      )
    }
  }
}

dependencies {
  compile project(':data')
  compile project(':r2-core')
  compile project(':li-jersey-uri')
  compile project(':generator')
  compile project(':pegasus-common')
  compile project(':restli-common')
  compile project(':restli-client')
  compile project(':restli-server')
  compile externalDependency.caffeine
  compile externalDependency.commonsIo
  compile externalDependency.codemodel
  compile externalDependency.commonsCli
  compile externalDependency.commonsLang
  compile externalDependency.jacksonCore
  compile externalDependency.jacksonDataBind
  compile externalDependency.jdkTools
  compile externalDependency.velocity

  testCompile externalDependency.mockito
  testCompile externalDependency.testng
  testCompile externalDependency.junit
  testCompile externalDependency.commonsHttpClient
  testCompile externalDependency.javaparser

  if (JavaVersion.current() >= JavaVersion.VERSION_11) {
    // Custom dependency set is required for JDK11+ only source set
    java17Compile project(':data')
    java17Compile project(':r2-core')
    java17Compile project(':li-jersey-uri')
    java17Compile project(':generator')
    java17Compile project(':pegasus-common')
    java17Compile project(':restli-common')
    java17Compile project(':restli-client')
    java17Compile project(':restli-server')
    java17Compile externalDependency.caffeine
    java17Compile externalDependency.commonsIo
    java17Compile externalDependency.codemodel
    java17Compile externalDependency.commonsCli
    java17Compile externalDependency.commonsLang
    java17Compile externalDependency.jacksonCore
    java17Compile externalDependency.jacksonDataBind
    java17Compile externalDependency.velocity

    java17Compile externalDependency.mockito
    java17Compile externalDependency.testng
    java17Compile externalDependency.junit
    java17Compile externalDependency.commonsHttpClient
    java17Compile externalDependency.javaparser
  }
}

apply from: "${buildScriptDirPath}/restModel.gradle"
